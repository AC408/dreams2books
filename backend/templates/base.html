<!DOCTYPE html>
<html>
  <head>
    <title>Dreams2Books - Find Books From Your Dreams</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>

  <body>
    <div class="container">
      <header class="hero">
        <h1>Dreams2Books</h1>
        <p class="subtitle">Find the perfect book inspired by your dreams</p>

        <div class="search-container">
          <!-- Step Indicators -->
          <div class="form-steps" id="step-indicators">
            <div class="step-indicator">
              <div class="step active" id="step-1-indicator">1</div>
              <div class="step-line"></div>
              <div class="step" id="step-2-indicator">2</div>
              <div class="step-line"></div>
              <div class="step" id="step-3-indicator">3</div>
            </div>
          </div>

          <!-- Multi-page steps for first-time input -->
          <div id="multi-step-form">
            <!-- Step 1: Dream Description -->
            <div class="form-step" id="step-1">
              <div class="input-box-container">
                <label for="filter-text-val1" class="input-label"
                  >Describe your dreams (minimum 15 words)</label
                >
                <div class="input-box">
                  <textarea
                    placeholder="Describe your dreams (minimum 15 words)"
                    id="filter-text-val1"
                    rows="4"
                  ></textarea>
                </div>
                <span id="word-count">0 words</span>
              </div>
              <div class="form-buttons">
                <button id="next-step-1" class="next-button" disabled>
                  Next
                </button>
              </div>
              <div class="example-container">
                <h4>Example Dream Descriptions:</h4>
                <div class="example-box">
                  <p>
                    "I was swimming with elephants in my bathtub and they
                    started playing trumpets. Then we were in the ocean and the
                    elephants wore sunglasses. After that my kindergarten
                    teacher gave me an A+ for playing the trumpet."
                  </p>
                </div>
                <div class="example-box">
                  <p>
                    "I was making a sandwich but the sandwich ran away to run a
                    marathon. I chased it but just couldn't catch up. Eventually
                    it won the race so I finally caught it but woke up before I
                    could eat it."
                  </p>
                </div>
                <div class="example-box">
                  <p>
                    "I was a lady in the Regency era and I amassed a large
                    fortune by marrying an agreeable gentleman and inherited the
                    estate as well. Then we raised a family in our house."
                  </p>
                </div>
              </div>
            </div>

            <!-- Step 2: Dream Feelings -->
            <div class="form-step" id="step-2" style="display: none">
              <div class="input-box-container">
                <label for="filter-text-val2" class="input-label"
                  >How did you feel about your dream?</label
                >
                <div class="input-box">
                  <textarea
                    placeholder="How did you feel about your dream?"
                    id="filter-text-val2"
                    rows="4"
                  ></textarea>
                </div>
              </div>
              <div class="form-buttons">
                <button id="prev-step-2" class="prev-button">Previous</button>
                <button id="next-step-2" class="next-button" disabled>
                  Next
                </button>
              </div>
              <div class="example-container">
                <h4>Example Feelings:</h4>
                <div class="example-box">
                  <p>
                    "Confused, happy, impressed by elephant music, cozy,
                    disappointed to wake up"
                  </p>
                </div>
                <div class="example-box">
                  <p>"Annoyed, exhausted, hungry"</p>
                </div>
                <div class="example-box">
                  <p>"Happy, sentimental, charmed"</p>
                </div>
              </div>
            </div>

            <!-- Step 3: Genre Selection -->
            <div class="form-step" id="step-3" style="display: none">
              <div class="input-box-container">
                <label for="genre-selector" class="input-label"
                  >Book Genre</label
                >
                <select id="genre-selector" class="genre-dropdown">
                  <option value="Any">Any</option>
                  <option value="Fantasy">Fantasy</option>
                  <option value="Mystery">Mystery</option>
                  <option value="Romance">Romance</option>
                  <option value="Horror">Horror</option>
                  <option value="Fiction">Fiction</option>
                  <option value="Biography">Biography</option>
                  <option value="History">History</option>
                  <option value="Adventure">Adventure</option>
                  <option value="Poetry">Poetry</option>
                </select>
              </div>
              <div class="form-buttons">
                <button id="prev-step-3" class="prev-button">Previous</button>
                <button id="generate-button-multi" class="generate-button">
                  Generate
                </button>
              </div>
            </div>
          </div>

          <!-- Single-page all inputs view (shown after first submission) -->
          <div id="single-page-form" style="display: none">
            <div class="input-box-container">
              <label for="filter-text-val1-single" class="input-label"
                >Describe your dreams (minimum 15 words)</label
              >
              <div class="input-box">
                <textarea
                  placeholder="Describe your dreams (minimum 15 words)"
                  id="filter-text-val1-single"
                  rows="4"
                ></textarea>
              </div>
              <span id="word-count-single">0 words</span>
            </div>

            <div class="input-box-container">
              <label for="filter-text-val2-single" class="input-label"
                >How did you feel about your dream?</label
              >
              <div class="input-box">
                <textarea
                  placeholder="How did you feel about your dream?"
                  id="filter-text-val2-single"
                  rows="4"
                ></textarea>
              </div>
            </div>

            <div class="input-box-container">
              <label for="genre-selector-single" class="input-label"
                >Book Genre</label
              >
              <select id="genre-selector-single" class="genre-dropdown">
                <option value="Any">Any</option>
                <option value="Fantasy">Fantasy</option>
                <option value="Mystery">Mystery</option>
                <option value="Romance">Romance</option>
                <option value="Horror">Horror</option>
                <option value="Fiction">Fiction</option>
                <option value="Biography">Biography</option>
                <option value="History">History</option>
                <option value="Adventure">Adventure</option>
                <option value="Poetry">Poetry</option>
              </select>
            </div>

            <div class="form-buttons">
              <button id="reset-button" class="prev-button">Start Over</button>
              <button id="generate-button-single" class="generate-button">
                Regenerate
              </button>
            </div>
          </div>
        </div>
      </header>

      <div class="results-wrapper">
        <div id="progress-indicator" style="display: none">
          <span class="loader"></span><span id="progress-text"></span>
        </div>
        <main id="answer-box"></main>
      </div>
    </div>

    <script>
      // Track if we've submitted a search before
      let hasSubmitted = false;

      function answerBoxTemplate(
        Title,
        authors,
        infoLink,
        similarity_score,
        description,
        top_features,
        cos_explanation,
        hidden_explanation
      ) {
        // formatting the author text bc we got brackets and quotes in the dataset
        let authorText = Array.isArray(authors) ? authors.join(", ") : authors;
        authorText = authorText.replace(/['\[\]]/g, "");

        // uppercasing first letter bc our dataset si full of lowercase lol
        const capitalizedTitle =
          Title.charAt(0).toUpperCase() + Title.slice(1).toLowerCase();

        // construct image url with this nice little trick but unscalable trick. so we actually did have the image url in our dataset, but we trimmed it. but you can construct it like this since its just the google books api same as the book id.
        const bookIdMatch = infoLink.match(/id=([^&]+)/);
        const bookId = bookIdMatch ? bookIdMatch[1] : "";
        const coverImageUrl = bookId
          ? `https://books.google.com/books/content?id=${bookId}&printsec=frontcover&img=1&zoom=1&source=gbs_api`
          : "";

        const hasCover = bookId !== "";

        const formattedScore = similarity_score
          ? `Similarity: ${parseFloat(similarity_score).toFixed(2)}`
          : "N/A";

        return `
        <div class="book-card ${hasCover ? "has-cover" : ""}">
          ${
            hasCover
              ? `
              <div class="book-cover-container">
                <div class="book-cover">
                  <img src="${coverImageUrl}" alt="${capitalizedTitle} cover" />
                </div>
                <span class="book-rank">${formattedScore}</span>
              </div>`
              : ""
          }
          <div class="book-content">
            <div class="book-header">
              <h3 class="book-title">${capitalizedTitle}</h3>
            </div>
            <p class="book-authors">By ${authorText}</p>
            <div class="book-features">
              ${
                top_features && top_features.length > 0
                  ? top_features
                      .map(
                        (feature) =>
                          `<span class="feature-tag">${feature}</span>`
                      )
                      .join("")
                  : ""
              }
            </div>
            <p class="book-description">${
              description || "No description available"
            }</p>
            <div class="explanations">
              <p class="explanation-title">Important Query Word Matches</p>
              <div class="explanation-tags">
                ${
                  cos_explanation &&
                  Array.isArray(cos_explanation) &&
                  cos_explanation.length > 0
                    ? cos_explanation
                        .map(
                          (word) =>
                            `<span class="explanation-tag">${word}</span>`
                        )
                        .join("")
                    : '<span class="explanation-tag">N/A</span>'
                }
              </div>
              <p class="explanation-title explanation-hidden">Hidden Correlations Calculation</p>
              <div class="explanation-tags explanation-hidden">
                 ${
                   hidden_explanation &&
                   Array.isArray(hidden_explanation) &&
                   hidden_explanation.length > 0
                     ? hidden_explanation
                         .map(
                           (word) =>
                             `<span class="explanation-tag">${word}</span>`
                         )
                         .join("")
                     : '<span class="explanation-tag">N/A</span>'
                 }
              </div>
            </div>
            <a href="${infoLink}" target="_blank" class="book-link">View on Google Books</a>
          </div>
        </div>`;
      }

      function filterText(isRegeneration = false) {
        document.getElementById("answer-box").innerHTML = "";
        const progressIndicator = document.getElementById("progress-indicator");
        const progressText = document.getElementById("progress-text");
        progressIndicator.style.display = "none";

        // Get values from appropriate input fields based on form mode
        const query1 = isRegeneration
          ? document.getElementById("filter-text-val1-single").value
          : document.getElementById("filter-text-val1").value;

        const query2 = isRegeneration
          ? document.getElementById("filter-text-val2-single").value
          : document.getElementById("filter-text-val2").value;

        const genreSelect = isRegeneration
          ? document.getElementById("genre-selector-single")
          : document.getElementById("genre-selector");

        const selectedGenre =
          genreSelect.options[genreSelect.selectedIndex].value;
        const wordCount = query1.trim().split(/\s+/).filter(Boolean).length;

        if (wordCount < 15) {
          document.getElementById("answer-box").innerHTML =
            "<div class='error'>Dream description must have at least 15 words.</div>";
          return;
        }
        if (query2.trim().length === 0) {
          document.getElementById("answer-box").innerHTML =
            "<div class='error'>Please also describe how you felt about the dream.</div>";
          return;
        }

        let query = query1 + " " + query1 + " " + query2;

        if (selectedGenre !== "Any") {
          query += " The genre is " + selectedGenre;
        }

        const progressMessages = [
          "Looking through the backend...",
          "Analyzing your dream description...",
          "Comparing dream vibes with book plots...",
          "Finding the best book matches...",
        ];
        let currentMessageIndex = 0;
        let progressInterval;

        progressText.textContent = progressMessages[currentMessageIndex];
        progressIndicator.style.display = "block";

        progressInterval = setInterval(() => {
          currentMessageIndex =
            (currentMessageIndex + 1) % progressMessages.length;
          progressText.style.opacity = 0;
          setTimeout(() => {
            progressText.textContent = progressMessages[currentMessageIndex];
            progressText.style.opacity = 1;
          }, 300);
        }, 4000);

        fetch("/episodes?" + new URLSearchParams({ title: query }).toString())
          .then((response) => response.json())
          .then((data) => {
            clearInterval(progressInterval);
            progressIndicator.style.display = "none";

            // If this is the first time generating results, switch to single page view
            if (!hasSubmitted) {
              switchToSinglePageView();
              hasSubmitted = true;
            }

            document.getElementById("answer-box").innerHTML = "";
            if (data.length === 0) {
              document.getElementById("answer-box").innerHTML =
                "<div class='no-results'>No books found matching your dream.</div>";
              return;
            }

            const resultsHeading = document.createElement("h2");
            resultsHeading.className = "results-heading";
            resultsHeading.textContent = "Recommended Books";
            document.getElementById("answer-box").appendChild(resultsHeading);

            const resultsGrid = document.createElement("div");
            resultsGrid.className = "results-list";
            document.getElementById("answer-box").appendChild(resultsGrid);

            data.forEach((row) => {
              let tempDiv = document.createElement("div");
              tempDiv.innerHTML = answerBoxTemplate(
                row.Title,
                row.authors,
                row.infoLink,
                row.similarity_score,
                row.description,
                row.top_features,
                row.cos_explanation,
                row.hidden_explanation
              );
              resultsGrid.appendChild(tempDiv.firstElementChild);
            });
          })
          .catch((error) => {
            clearInterval(progressInterval);
            progressIndicator.style.display = "none";
            console.error("Error fetching recommendations:", error);
            document.getElementById("answer-box").innerHTML =
              "<div class='error'>Could not fetch recommendations. Please try again later.</div>";
          });
      }

      // Function to switch from multi-step to single page view
      function switchToSinglePageView() {
        // Copy values from multi-step form to single page form
        document.getElementById("filter-text-val1-single").value =
          document.getElementById("filter-text-val1").value;

        document.getElementById("filter-text-val2-single").value =
          document.getElementById("filter-text-val2").value;

        const multiGenre = document.getElementById("genre-selector");
        const singleGenre = document.getElementById("genre-selector-single");
        singleGenre.selectedIndex = multiGenre.selectedIndex;

        // Update word count in single view
        const words = document
          .getElementById("filter-text-val1-single")
          .value.trim()
          .split(/\s+/)
          .filter(Boolean);
        const wordCount = words.length;
        document.getElementById(
          "word-count-single"
        ).textContent = `${wordCount} word${wordCount !== 1 ? "s" : ""}`;

        // Hide step indicators and multi-step form, show single page form
        document.getElementById("step-indicators").style.display = "none";
        document.getElementById("multi-step-form").style.display = "none";
        document.getElementById("single-page-form").style.display = "block";
      }

      // Function to reset to multi-step view
      function resetToMultiStepView() {
        // Reset all inputs
        document.getElementById("filter-text-val1").value = "";
        document.getElementById("filter-text-val2").value = "";
        document.getElementById("genre-selector").selectedIndex = 0;
        document.getElementById("word-count").textContent = "0 words";

        // Reset to step 1
        document.getElementById("step-1").style.display = "block";
        document.getElementById("step-2").style.display = "none";
        document.getElementById("step-3").style.display = "none";

        document.getElementById("step-1-indicator").classList.add("active");
        document.getElementById("step-2-indicator").classList.remove("active");
        document.getElementById("step-3-indicator").classList.remove("active");

        // Show multi-step form, hide single page form
        document.getElementById("step-indicators").style.display = "block";
        document.getElementById("multi-step-form").style.display = "block";
        document.getElementById("single-page-form").style.display = "none";

        // Clear results
        document.getElementById("answer-box").innerHTML = "";

        // Reset submission state
        hasSubmitted = false;
      }

      // Multi-step form logic
      const dreamInput = document.getElementById("filter-text-val1");
      const feelingInput = document.getElementById("filter-text-val2");
      const wordCountDisplay = document.getElementById("word-count");

      // Step 1 logic
      const nextStep1Button = document.getElementById("next-step-1");
      dreamInput.addEventListener("input", function () {
        const words = this.value.trim().split(/\s+/).filter(Boolean);
        const currentWordCount = words.length;

        wordCountDisplay.textContent = `${currentWordCount} word${
          currentWordCount !== 1 ? "s" : ""
        }`;
        wordCountDisplay.style.color =
          currentWordCount < 15 ? "#e53e3e" : "var(--medium-light)";

        nextStep1Button.disabled = currentWordCount < 15;
      });

      nextStep1Button.addEventListener("click", function () {
        document.getElementById("step-1").style.display = "none";
        document.getElementById("step-2").style.display = "block";
        document.getElementById("step-1-indicator").classList.remove("active");
        document.getElementById("step-2-indicator").classList.add("active");
      });

      // Step 2 logic
      const prevStep2Button = document.getElementById("prev-step-2");
      const nextStep2Button = document.getElementById("next-step-2");

      feelingInput.addEventListener("input", function () {
        nextStep2Button.disabled = this.value.trim().length === 0;
      });

      prevStep2Button.addEventListener("click", function () {
        document.getElementById("step-2").style.display = "none";
        document.getElementById("step-1").style.display = "block";
        document.getElementById("step-2-indicator").classList.remove("active");
        document.getElementById("step-1-indicator").classList.add("active");
      });

      nextStep2Button.addEventListener("click", function () {
        document.getElementById("step-2").style.display = "none";
        document.getElementById("step-3").style.display = "block";
        document.getElementById("step-2-indicator").classList.remove("active");
        document.getElementById("step-3-indicator").classList.add("active");
      });

      // Step 3 logic
      const prevStep3Button = document.getElementById("prev-step-3");

      prevStep3Button.addEventListener("click", function () {
        document.getElementById("step-3").style.display = "none";
        document.getElementById("step-2").style.display = "block";
        document.getElementById("step-3-indicator").classList.remove("active");
        document.getElementById("step-2-indicator").classList.add("active");
      });

      // Connect buttons to their functions
      document
        .getElementById("generate-button-multi")
        .addEventListener("click", function () {
          filterText(false); // First-time generation
        });

      document
        .getElementById("generate-button-single")
        .addEventListener("click", function () {
          filterText(true); // Regeneration from single-page view
        });

      document
        .getElementById("reset-button")
        .addEventListener("click", resetToMultiStepView);

      // Single page form logic
      const dreamInputSingle = document.getElementById(
        "filter-text-val1-single"
      );
      const feelingInputSingle = document.getElementById(
        "filter-text-val2-single"
      );
      const wordCountDisplaySingle =
        document.getElementById("word-count-single");
      const generateButtonSingle = document.getElementById(
        "generate-button-single"
      );

      dreamInputSingle.addEventListener("input", function () {
        const words = this.value.trim().split(/\s+/).filter(Boolean);
        const currentWordCount = words.length;

        wordCountDisplaySingle.textContent = `${currentWordCount} word${
          currentWordCount !== 1 ? "s" : ""
        }`;
        wordCountDisplaySingle.style.color =
          currentWordCount < 15 ? "#e53e3e" : "var(--medium-light)";

        updateSingleGenerateButton();
      });

      feelingInputSingle.addEventListener("input", updateSingleGenerateButton);

      function updateSingleGenerateButton() {
        const dreamText = dreamInputSingle.value.trim();
        const feelingText = feelingInputSingle.value.trim();
        const wordCount = dreamText.split(/\s+/).filter(Boolean).length;

        generateButtonSingle.disabled =
          wordCount < 15 || feelingText.length === 0;
      }

      // Handle Enter key in textareas
      dreamInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter" && !e.shiftKey && !nextStep1Button.disabled) {
          e.preventDefault();
          nextStep1Button.click();
        }
      });

      feelingInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter" && !e.shiftKey && !nextStep2Button.disabled) {
          e.preventDefault();
          nextStep2Button.click();
        }
      });
    </script>
  </body>
</html>
