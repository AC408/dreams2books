<!DOCTYPE html>
<html>
  <head>
    <title>Dreams2Books - Find Books From Your Dreams</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container">
      <header class="hero">
        <h1>Dreams2Books</h1>
        <p class="subtitle">Find the perfect book inspired by your dreams</p>

        <div class="search-container">
          <textarea
            placeholder="Describe your dream..."
            id="filter-text-val"
            rows="6"
          ></textarea>
          <button onclick="filterText()">Generate Recommendations</button>
        </div>
      </header>

      <div class="results-wrapper">
        <main id="answer-box"></main>
      </div>
    </div>

    <script>
      function answerBoxTemplate(Title, authors, infoLink, rank, description) {
        // formatting the author text bc we got brackets and quotes in the dataset
        let authorText = Array.isArray(authors) ? authors.join(", ") : authors;
        authorText = authorText.replace(/['\[\]]/g, "");

        // uppercasing first letter bc our dataset si full of lowercase lol
        const capitalizedTitle =
          Title.charAt(0).toUpperCase() + Title.slice(1).toLowerCase();

        // construct image url with this nice little trick but unscalable trick. so we actually did have the image url in our dataset, but we trimmed it. but you can construct it like this since its just the google books api same as the book id.
        const bookIdMatch = infoLink.match(/id=([^&]+)/);
        const bookId = bookIdMatch ? bookIdMatch[1] : "";
        const coverImageUrl = bookId
          ? `https://books.google.com/books/content?id=${bookId}&printsec=frontcover&img=1&zoom=1&source=gbs_api`
          : "";

        const hasCover = bookId !== "";

        return `
        <div class="book-card ${hasCover ? "has-cover" : ""}">
          <span class="book-rank">${rank}</span>
          ${
            hasCover
              ? `<div class="book-cover">
            <img src="${coverImageUrl}" alt="${capitalizedTitle} cover" />
          </div>`
              : ""
          }
          <div class="book-content">
            <div class="book-header">
              <h3 class="book-title">${capitalizedTitle}</h3>
            </div>
            <p class="book-authors">By ${authorText}</p>
            <p class="book-description">${
              description || "No description available"
            }</p>
            <a href="${infoLink}" target="_blank" class="book-link">View on Google Books</a>
          </div>
        </div>`;
      }

      function createLoadingState() {
        let loadingHTML = '<h2 class="results-heading">Recommended Books</h2>';
        loadingHTML += '<div class="loading-grid">';

        for (let i = 0; i < 6; i++) {
          loadingHTML += '<div class="loading-card"></div>';
        }

        loadingHTML += "</div>";
        return loadingHTML;
      }

      function filterText() {
        document.getElementById("answer-box").innerHTML = "";
        const query = document.getElementById("filter-text-val").value;
        if (query.length === 0) return;

        // loading state
        document.getElementById("answer-box").innerHTML = createLoadingState();

        fetch("/episodes?" + new URLSearchParams({ title: query }).toString())
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("answer-box").innerHTML = "";
            if (data.length === 0) {
              document.getElementById("answer-box").innerHTML =
                "<div class='no-results'>No books found matching your dream.</div>";
              return;
            }

            const resultsHeading = document.createElement("h2");
            resultsHeading.className = "results-heading";
            resultsHeading.textContent = "Recommended Books";
            document.getElementById("answer-box").appendChild(resultsHeading);

            const resultsGrid = document.createElement("div");
            resultsGrid.className = "results-grid";
            document.getElementById("answer-box").appendChild(resultsGrid);

            data.forEach((row) => {
              let tempDiv = document.createElement("div");
              tempDiv.innerHTML = answerBoxTemplate(
                row.Title,
                row.authors,
                row.infoLink,
                row.rank,
                row.description
              );
              resultsGrid.appendChild(tempDiv.firstElementChild);
            });
          })
          .catch(() => {
            document.getElementById("answer-box").innerHTML =
              "<div class='error'>Something went wrong. Please try again.</div>";
          });
      }

      document
        .getElementById("filter-text-val")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            filterText();
          }
        });
    </script>
  </body>
</html>
